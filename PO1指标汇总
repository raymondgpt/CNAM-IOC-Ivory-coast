/*Indicator NO.5 Taux de départ des opérateurs*/
--ODS LAYER
-- This table stores the enrollment and departure information of operators (in site).
DROP TABLE IF EXISTS ods.ods_fichiers_sources_fichier_operateur_enrolement;
CREATE TABLE ods.ods_fichiers_sources_fichier_operateur_enrolement (
  `observation_number` VARCHAR(255) NULL,
  `first_last_name` VARCHAR(255) NULL,
  `employee_id` VARCHAR(255) NULL,
  `job_function` VARCHAR(255) NULL,
  `department_direction` VARCHAR(255) NULL,
  `department` VARCHAR(255) NULL,
  `service` VARCHAR(255) NULL,
  `assigned_site` VARCHAR(255) NULL,
  `start_date` VARCHAR(255) NULL,
  `departure_date` VARCHAR(255) NULL,
  `departure_type` VARCHAR(255) NULL,
  `departure_reason` VARCHAR(255) NULL,
  `notice_respected` VARCHAR(255) NULL,
  `replacement_identified` VARCHAR(255) NULL,
  `replacement_name` VARCHAR(255) NULL,
  `transition_date` VARCHAR(255) NULL,
  `comments` VARCHAR(255) NULL,
  `etl_time` DATETIME NULL DEFAULT CURRENT_TIMESTAMP
) ENGINE=OLAP
DUPLICATE KEY(`observation_number`)
COMMENT 'OLAP'
DISTRIBUTED BY HASH(`observation_number`) BUCKETS 10
PROPERTIES (
    "replication_num" = "2"
);

-- DW LAYER
-- This table stores the enrollment and departure information of operators (in site).
DROP VIEW IF EXISTS dw.dw_fichier_operateur_enrolement;
CREATE VIEW dw.dw_fichier_operateur_enrolement COMMENT 'VIEW' AS
select
    observation_number,
    first_last_name,
    employee_id,
    job_function,
    department_direction,
    department,
    service,
    assigned_site,
    start_date,
    departure_date,
    departure_type,
    departure_reason,
    notice_respected,
    replacement_identified,
    replacement_name,
    transition_date,
    comments,
    etl_time
from
    `internal`.`ods`.`ods_fichiers_sources_fichier_operateur_enrolement`;


-- DM LAYER
-- This table calculates the monthly turnover rate of on-site operators (departures divided by active employees at the beginning of the month).
DROP VIEW IF EXISTS dm.dm_operator_turnover_rate_monthly;
CREATE  VIEW dm.dm_operator_turnover_rate_monthly COMMENT 'VIEW' AS
WITH all_months AS (
    SELECT DISTINCT DATE_FORMAT(month_date, '%Y%m') as month_key
    FROM (
        SELECT
            DATE_ADD(first_day_of_first_month,INTERVAL (t2*10 + t1) MONTH) as month_date
        FROM (
            SELECT
                DATE_SUB(DATE_FORMAT(MIN(start_date), '%Y-%m-01'), INTERVAL 0 DAY) as first_day_of_first_month
            FROM `internal`.`dw`.`dw_fichier_operateur_enrolement`
            WHERE start_date IS NOT NULL
        ) first_month
        CROSS JOIN (SELECT 0 as t1 UNION SELECT 1 UNION SELECT 2 UNION SELECT 3 UNION SELECT 4 UNION SELECT 5 UNION SELECT 6 UNION SELECT 7 UNION SELECT 8 UNION SELECT 9) t1
        CROSS JOIN (SELECT 0 as t2 UNION SELECT 1 UNION SELECT 2 UNION SELECT 3 UNION SELECT 4) t2
        WHERE DATE_ADD(
                first_day_of_first_month,
                INTERVAL (t2*10 + t1) MONTH
            ) <= CURDATE()
    ) month_dates
)
SELECT
    COALESCE(departure.departure_num, 0) as departure_num,
    COALESCE(active.active_num, 0) as active_num,
    CASE
        WHEN COALESCE(active.active_num, 0) = 0 THEN 0
        ELSE ROUND(COALESCE(departure.departure_num, 0) / COALESCE(active.active_num, 0), 2)
    END as departure_rate,
    all_months.month_key as analysis_month,
    DATE_FORMAT(STR_TO_DATE(all_months.month_key,'%Y%m'), '%b-%Y') as month,
    COALESCE(departure.etl_time, CURRENT_TIMESTAMP) as etl_time
FROM all_months
LEFT JOIN (
    SELECT
        DATE_FORMAT(departure_date, '%Y%m') as month_key,
        COUNT(1) as departure_num,
        MAX(etl_time) as etl_time
    FROM `internal`.`dw`.`dw_fichier_operateur_enrolement`
    WHERE departure_date IS NOT NULL AND departure_date <> ''
    GROUP BY DATE_FORMAT(departure_date, '%Y%m')
) departure ON all_months.month_key = departure.month_key
LEFT JOIN (
    -- Number of active employees at the beginning of each month
    SELECT
        month_key,
        COUNT(DISTINCT employee_id) as active_num
    FROM (
        SELECT
            am.month_key,
            emp.employee_id
        FROM all_months am
        CROSS JOIN `internal`.`dw`.`dw_fichier_operateur_enrolement` emp
        WHERE emp.start_date IS NOT NULL
    ) emp_months
    WHERE
        EXISTS (
            SELECT 1
            FROM `internal`.`dw`.`dw_fichier_operateur_enrolement` e
            WHERE e.employee_id = emp_months.employee_id
            AND e.start_date <= STR_TO_DATE(CONCAT(emp_months.month_key, '01'), '%Y%m%d')
            AND (
                e.departure_date IS NULL
                OR e.departure_date='NULL'
                OR e.departure_date = ''
                OR e.departure_date > STR_TO_DATE(CONCAT(emp_months.month_key, '01'), '%Y%m%d')
            )
        )
    GROUP BY month_key
) active ON all_months.month_key = active.month_key
where active_num is not null
ORDER BY all_months.month_key;


-- This table calculates the annual turnover rate of on-site operators (annual departures divided by active employees at the beginning of the year).
DROP VIEW IF EXISTS dm.dm_operator_turnover_rate_yearly;
CREATE  VIEW dm.dm_operator_turnover_rate_yearly COMMENT 'VIEW' AS
WITH all_years AS (
    SELECT DISTINCT DATE_FORMAT(year_date, '%Y') as year_key
    FROM (
        SELECT
            DATE_ADD(first_day_of_first_year,INTERVAL t1 YEAR) as year_date
        FROM (
            -- Get January 1st of the year with the earliest employee hire date
            SELECT
                DATE_FORMAT(MIN(start_date), '%Y-01-01') as first_day_of_first_year
            FROM `internal`.`dw`.`dw_fichier_operateur_enrolement`
            WHERE start_date IS NOT NULL
        ) first_year
        CROSS JOIN (SELECT 0 as t1 UNION SELECT 1 UNION SELECT 2 UNION SELECT 3 UNION SELECT 4 UNION SELECT 5 UNION SELECT 6 UNION SELECT 7 UNION SELECT 8 UNION SELECT 9) t1
        CROSS JOIN (SELECT 0 as t2 UNION SELECT 1 UNION SELECT 2 UNION SELECT 3 UNION SELECT 4 UNION SELECT 5 UNION SELECT 6 UNION SELECT 7 UNION SELECT 8 UNION SELECT 9) t2
        WHERE DATE_ADD(
                first_day_of_first_year,
                INTERVAL (t2*10 + t1) YEAR
            ) <= CURDATE()
    ) year_dates
)
SELECT
    COALESCE(departure.departure_num, 0) as departure_num,
    COALESCE(active.active_num, 0) as active_num,
    CASE
        WHEN COALESCE(active.active_num, 0) = 0 THEN 0
        ELSE ROUND(COALESCE(departure.departure_num, 0) / COALESCE(active.active_num, 0), 2)
    END as departure_rate,
    all_years.year_key as analysis_year,
    COALESCE(departure.etl_time, CURRENT_TIMESTAMP) as etl_time
FROM all_years
LEFT JOIN (
    -- Annual number of departing employees
    SELECT
        DATE_FORMAT(departure_date, '%Y') as year_key,
        COUNT(1) as departure_num,
        MAX(etl_time) as etl_time
    FROM `internal`.`dw`.`dw_fichier_operateur_enrolement`
    WHERE departure_date IS NOT NULL AND departure_date <> ''
    GROUP BY DATE_FORMAT(departure_date, '%Y')
) departure ON all_years.year_key = departure.year_key
LEFT JOIN (
    SELECT
        year_key,
        COUNT(DISTINCT employee_id) as active_num
    FROM (
        SELECT
            ay.year_key,
            emp.employee_id
        FROM all_years ay
        CROSS JOIN `internal`.`dw`.`dw_fichier_operateur_enrolement` emp
        WHERE emp.start_date IS NOT NULL
    ) emp_years
    WHERE
        -- Number of active employees at the beginning of each year (January 1st)
        EXISTS (
            SELECT 1
            FROM `internal`.`dw`.`dw_fichier_operateur_enrolement` e
            WHERE e.employee_id = emp_years.employee_id
            AND e.start_date <= STR_TO_DATE(CONCAT(emp_years.year_key, '0101'), '%Y%m%d')
            AND (
                e.departure_date IS NULL
                OR e.departure_date='NULL'
                OR e.departure_date = ''
                OR e.departure_date > STR_TO_DATE(CONCAT(emp_years.year_key, '0101'), '%Y%m%d')
            )
        )
    GROUP BY year_key
) active ON all_years.year_key = active.year_key
WHERE active_num IS NOT NULL
ORDER BY all_years.year_key;



-- This table calculates the monthly turnover rate of operators by each on-site (departures divided by active employees at the beginning of the month per site).
DROP VIEW IF EXISTS dm.dm_operator_turnover_rate_monthly_by_site;
CREATE VIEW dm.`dm_operator_turnover_rate_monthly_by_site` COMMENT 'VIEW' AS
WITH all_months AS (
    SELECT DISTINCT DATE_FORMAT(month_date, '%Y%m') as month_key
    FROM (
        SELECT
            DATE_ADD(first_day_of_first_month, INTERVAL (t2*10 + t1) MONTH) as month_date
        FROM (
            SELECT
                DATE_SUB(DATE_FORMAT(MIN(start_date), '%Y-%m-01'), INTERVAL 0 DAY) as first_day_of_first_month
            FROM `internal`.`dw`.`dw_fichier_operateur_enrolement`
            WHERE start_date IS NOT NULL
        ) first_month
        CROSS JOIN (SELECT 0 as t1 UNION SELECT 1 UNION SELECT 2 UNION SELECT 3 UNION SELECT 4 UNION SELECT 5 UNION SELECT 6 UNION SELECT 7 UNION SELECT 8 UNION SELECT 9) t1
        CROSS JOIN (SELECT 0 as t2 UNION SELECT 1 UNION SELECT 2 UNION SELECT 3 UNION SELECT 4) t2
        WHERE DATE_ADD(
                first_day_of_first_month,
                INTERVAL (t2*10 + t1) MONTH
            ) <= CURDATE()
    ) month_dates
),
all_sites AS (
    SELECT DISTINCT assigned_site
    FROM `internal`.`dw`.`dw_fichier_operateur_enrolement`
    WHERE assigned_site IS NOT NULL AND assigned_site <> ''
),
month_site_combinations AS (
    SELECT
        am.month_key,
        s.assigned_site
    FROM all_months am
    CROSS JOIN all_sites s
)
SELECT
    msc.assigned_site,
    COALESCE(departure.departure_num, 0) as departure_num,
    COALESCE(active.active_num, 0) as active_num,
    CASE
        WHEN COALESCE(active.active_num, 0) = 0 THEN 0
        ELSE ROUND(COALESCE(departure.departure_num, 0) / COALESCE(active.active_num, 0), 2)
    END as departure_rate,
    msc.month_key as analysis_month,
    year(STR_TO_DATE(msc.month_key,'%Y%m')) as year,
    DATE_FORMAT(STR_TO_DATE(msc.month_key,'%Y%m'), '%b-%Y') as month,
    COALESCE(departure.etl_time, active.etl_time, CURRENT_TIMESTAMP) as etl_time
FROM month_site_combinations msc
LEFT JOIN (
    -- Monthly number of departing employees per assigned site
    SELECT
        DATE_FORMAT(departure_date, '%Y%m') as month_key,
        assigned_site,
        COUNT(1) as departure_num,
        MAX(etl_time) as etl_time
    FROM `internal`.`dw`.`dw_fichier_operateur_enrolement`
    WHERE departure_date IS NOT NULL
      AND departure_date <> ''
      AND assigned_site IS NOT NULL
      AND assigned_site <> ''
    GROUP BY DATE_FORMAT(departure_date, '%Y%m'), assigned_site
) departure ON msc.month_key = departure.month_key AND msc.assigned_site = departure.assigned_site
LEFT JOIN (
    -- Number of active employees at the beginning of each month per assigned site
    SELECT
        month_key,
        assigned_site,
        COUNT(DISTINCT employee_id) as active_num,
        MAX(etl_time) as etl_time
    FROM (
        SELECT
            msc.month_key,
            msc.assigned_site,
            emp.employee_id,
            emp.start_date,
            emp.departure_date,
            emp.etl_time
        FROM month_site_combinations msc
        INNER JOIN `internal`.`dw`.`dw_fichier_operateur_enrolement` emp
            ON msc.assigned_site = emp.assigned_site
        WHERE emp.start_date IS NOT NULL
          AND emp.assigned_site IS NOT NULL
          AND emp.assigned_site <> ''
    ) emp_months
    WHERE
        start_date <= STR_TO_DATE(CONCAT(month_key, '01'), '%Y%m%d')
        AND (
            departure_date IS NULL
			OR departure_date='NULL'
            OR departure_date = ''
            OR departure_date > STR_TO_DATE(CONCAT(month_key, '01'), '%Y%m%d')
        )
    GROUP BY month_key, assigned_site
) active ON msc.month_key = active.month_key AND msc.assigned_site = active.assigned_site
WHERE COALESCE(active.active_num, departure.departure_num) IS NOT NULL
ORDER BY msc.month_key, msc.assigned_site;


-- This table calculates the annual turnover rate of operators by each on-site (annual departures divided by active employees at the beginning of the year per site).
DROP VIEW IF EXISTS dm.dm_operator_turnover_rate_yearly_by_site;
CREATE VIEW dm.`dm_operator_turnover_rate_yearly_by_site` COMMENT 'VIEW' AS
WITH all_years AS (
    SELECT DISTINCT DATE_FORMAT(year_date, '%Y') as year_key
    FROM (
        SELECT
            DATE_ADD(first_day_of_first_year, INTERVAL t1 YEAR) as year_date
        FROM (
            SELECT
                DATE_FORMAT(MIN(start_date), '%Y-01-01') as first_day_of_first_year
            FROM `internal`.`dw`.`dw_fichier_operateur_enrolement`
            WHERE start_date IS NOT NULL
        ) first_year
        CROSS JOIN (SELECT 0 as t1 UNION SELECT 1 UNION SELECT 2 UNION SELECT 3 UNION SELECT 4
                    UNION SELECT 5 UNION SELECT 6 UNION SELECT 7 UNION SELECT 8 UNION SELECT 9
                    UNION SELECT 10 UNION SELECT 11 UNION SELECT 12 UNION SELECT 13 UNION SELECT 14
                    UNION SELECT 15 UNION SELECT 16 UNION SELECT 17 UNION SELECT 18 UNION SELECT 19
                    UNION SELECT 20) t1
        WHERE DATE_ADD(
                first_day_of_first_year,
                INTERVAL t1 YEAR
            ) <= CURDATE()
    ) year_dates
),
all_sites AS (
    -- Get all distinct non-null assigned sites
    SELECT DISTINCT assigned_site
    FROM `internal`.`dw`.`dw_fichier_operateur_enrolement`
    WHERE assigned_site IS NOT NULL AND assigned_site <> ''
),
year_site_combinations AS (
    SELECT
        ay.year_key,
        s.assigned_site
    FROM all_years ay
    CROSS JOIN all_sites s
)
SELECT
    ysc.assigned_site,
    COALESCE(departure.departure_num, 0) as departure_num,
    COALESCE(active.active_num, 0) as active_num,
    CASE
        WHEN COALESCE(active.active_num, 0) = 0 THEN 0
        ELSE ROUND(COALESCE(departure.departure_num, 0) / COALESCE(active.active_num, 0), 2)
    END as departure_rate,
    ysc.year_key as analysis_year,
    COALESCE(departure.etl_time, active.etl_time, CURRENT_TIMESTAMP) as etl_time
FROM year_site_combinations ysc
LEFT JOIN (
    SELECT
        DATE_FORMAT(departure_date, '%Y') as year_key,
        assigned_site,
        COUNT(1) as departure_num,
        MAX(etl_time) as etl_time
    FROM `internal`.`dw`.`dw_fichier_operateur_enrolement`
    WHERE departure_date IS NOT NULL
      AND departure_date <> ''
      AND assigned_site IS NOT NULL
      AND assigned_site <> ''
    GROUP BY DATE_FORMAT(departure_date, '%Y'), assigned_site
) departure ON ysc.year_key = departure.year_key AND ysc.assigned_site = departure.assigned_site
LEFT JOIN (
    -- Number of active employees at the beginning of each year (January 1st) per assigned site
    SELECT
        year_key,
        assigned_site,
        COUNT(DISTINCT employee_id) as active_num,
        MAX(etl_time) as etl_time
    FROM (
        SELECT
            ysc.year_key,
            ysc.assigned_site,
            emp.employee_id,
            emp.start_date,
            emp.departure_date,
            emp.etl_time
        FROM year_site_combinations ysc
        INNER JOIN `internal`.`dw`.`dw_fichier_operateur_enrolement` emp
            ON ysc.assigned_site = emp.assigned_site
        WHERE emp.start_date IS NOT NULL
          AND emp.assigned_site IS NOT NULL
          AND emp.assigned_site <> ''
    ) emp_years
    WHERE
        start_date <= STR_TO_DATE(CONCAT(year_key, '0101'), '%Y%m%d')
        AND (
            departure_date IS NULL
            OR departure_date='NULL'
            OR departure_date = ''
            OR departure_date > STR_TO_DATE(CONCAT(year_key, '0101'), '%Y%m%d')
        )
    GROUP BY year_key, assigned_site
) active ON ysc.year_key = active.year_key AND ysc.assigned_site = active.assigned_site
WHERE COALESCE(active.active_num, departure.departure_num) IS NOT NULL
ORDER BY ysc.year_key, ysc.assigned_site;

/*Indicator NO.12 Nombre de sites d'enrolement*/
-- ODS LAYER
-- This table records the number of card registrations for each site.
drop TABLE `ods`.`ods_fichiers_sources_excel_site_enrolement`;
CREATE TABLE `ods`.`ods_fichiers_sources_excel_site_enrolement` (
                                                                    `region` VARCHAR(255) NULL,
                                                                    `department` VARCHAR(255) NULL,
                                                                    `site_name` VARCHAR(255) NULL,
                                                                    `type` VARCHAR(255) NULL,
                                                                    `open_date` DATE NULL,
                                                                    `etl_time` DATETIME NULL DEFAULT CURRENT_TIMESTAMP
) ENGINE=OLAP
    DUPLICATE KEY(`region`)
COMMENT 'OLAP'
DISTRIBUTED BY HASH(`region`) BUCKETS 10
PROPERTIES (
    "replication_num" = "2"
);

-- DW LAYER
-- dw.dw_site_enrolement source(record the number of card registrations for each site)
DROP VIEW `dw`.`dw_site_enrollment`;
CREATE
    VIEW `dw`.`dw_site_enrollment` AS
select
    region,
    department,
    site_name,
    type,
    open_date,
    etl_time
from
    `ods`.`ods_fichiers_sources_excel_site_enrolement`;


-- DM LAYER
-- This table stores the count of enrollment sites by region.
DROP VIEW IF EXISTS dm.dm_enrollment_sites_number_by_region;
CREATE
    VIEW dm.dm_enrollment_sites_number_by_region  AS
select
    A.region,
    B.geo_name,
    A.site_num,
    A.etl_time
from
    (
        select
            region,
            count(1) as site_num,
            max(etl_time) as etl_time
        from
            `dw`.`dw_site_enrollment`
        group by
            region) A
        left join `dim`.`dim_country_district` B on
        A.region = B.name;

-- This table stores the quantity statistics of enrollment sites by year
DROP VIEW IF EXISTS dm.dm_enrollment_sites_number_by_year;
CREATE VIEW dm.dm_enrollment_sites_number_by_year AS
select
    count(1) as site_num,
    DATE_FORMAT(open_date,'%Y')  as open_year
from `dw`.`dw_site_enrollment`
group by DATE_FORMAT(open_date,'%Y');


-- This table stores the quantity statistics of enrollment sites by month
DROP VIEW IF EXISTS dm.dm_enrollment_sites_number_by_month;
CREATE VIEW dm.dm_enrollment_sites_number_by_month AS
select
    count(1) as site_num,
    DATE_FORMAT(open_date,'%Y%m') as open_month,
    DATE_FORMAT(open_date,'%b-%Y')  as eopen_month,
    DATE_FORMAT(open_date,'%Y') as year
from `dw`.`dw_site_enrollment`
group by DATE_FORMAT(open_date,'%Y%m'),DATE_FORMAT(open_date,'%b-%Y'),DATE_FORMAT(open_date,'%Y');



-- This table stores the quantity statistics of enrollment sites
DROP VIEW IF EXISTS dm.`dm_enrollment_sites`;
CREATE
    VIEW dm.`dm_enrollment_sites`  AS
select
    A.region,
    B.geo_name,
    A.site_name,
    A.type,
    A.site_num,
    DATE_FORMAT(A.open_date,'%Y')  as open_year,
    DATE_FORMAT(A.open_date,'%Y%m') as open_month,
    DATE_FORMAT(A.open_date,'%b-%Y')  as eopen_month,
    A.etl_time
from
    (
        select
            region,
            site_name,
            type,
            open_date,
            count(1) as site_num,
            max(etl_time) as etl_time
        from
            `dw`.`dw_site_enrollment`
        group by
            region,site_name,type,open_date) A
        left join `dim`.`dim_country_district` B on
        A.region = B.name;


/*Indicator NO.16 Nombre moyen de cartes produite par jour pour une imprimante*/
--ODS LAYER
--this table stores the card production(in situ) number of each site in each date
DROP TABLE IF EXISTS `ods_fichiers_sources_excel_production_declaratives`;
CREATE TABLE `ods_fichiers_sources_excel_production_declaratives` (
                                                                      `region` VARCHAR(255) NULL,
                                                                      `coordination` VARCHAR(255) NULL,
                                                                      `site` VARCHAR(255) NULL,
                                                                      `closing_date` DATE NULL,
                                                                      `total` DOUBLE NULL,
                                                                      `period` VARCHAR(255) NULL,
                                                                      `period_type` VARCHAR(255) NULL,
                                                                      `value` DOUBLE NULL,
                                                                      `etl_time` DATETIME NULL DEFAULT CURRENT_TIMESTAMP
) ENGINE=OLAP
    DUPLICATE KEY(`region`,`coordination`,`site`)
COMMENT 'OLAP'
DISTRIBUTED BY HASH(`region`,`coordination`,`site`) BUCKETS 10
PROPERTIES (
    "replication_num" = "2"
);
--this table stores the card production(prod masse) number of each site in each date
DROP TABLE IF EXISTS `ods`.`ods_fichiers_sources_excel_production_declaratives_prodmasse`;
CREATE TABLE IF NOT EXISTS `ods`.`ods_fichiers_sources_excel_production_declaratives_prodmasse` (
                                                                                                    `region` VARCHAR(255) NULL,
                                                                                                    `coordination` VARCHAR(255) NULL,
                                                                                                    `site` VARCHAR(255) NULL,
                                                                                                    `total` DOUBLE NULL,
                                                                                                    `closing_date` DATE NULL,   -- Newly added 0126
                                                                                                    `period` VARCHAR(255) NULL,
                                                                                                    `period_type` VARCHAR(255) NULL,
                                                                                                    `value` DOUBLE NULL,
                                                                                                    `etl_time` DATETIME NULL DEFAULT CURRENT_TIMESTAMP
) ENGINE=OLAP
    DUPLICATE KEY(`region`, `coordination`, `site`)
COMMENT 'OLAP'
DISTRIBUTED BY HASH(`region`, `coordination`, `site`) BUCKETS 10
PROPERTIES (
    "replication_num" = "2"
);

--DW LAYER
--this table stores the card production(in situ) number of each site in each date
DROP VIEW dw.`dw_production_declaratives`;
CREATE
    VIEW dw.`dw_production_declaratives`  AS
select
    region,
    UPPER(coordination) as coordination,
    site,
    closing_date,   -- Newly added 0126
    total,
    period,
    'In Situ' as production_type,  -- Newly added
    period_type,
    value,
    etl_time
from
    `ods`.`ods_fichiers_sources_excel_production_declaratives`
where
    value is not null;

--this table stores the card production(prod masse) number of each site in each date
drop view if exists `dw`.`dw_production_declaratives_prodmasse`;
create view `dw`.`dw_production_declaratives_prodmasse`
as
select region,
       UPPER(coordination) as coordination,
       site,
       total,
       closing_date,   -- Newly added 0126
       period,
       'Production de masse' as production_type,
       period_type,
       value,
       etl_time
from `ods`.`ods_fichiers_sources_excel_production_declaratives_prodmasse`
where value is not null ;

--this table records all of the card production number(in situ)
drop view if exists  dw.`dw_production_declaratives_all_data`;
CREATE
    VIEW dw.`dw_production_declaratives_all_data`  AS
select
    region,
    UPPER(coordination) as coordination,
    site,
    closing_date,
    total,
    period,
    'in suite' as production_type,
    period_type,
    value,
    etl_time
from
    `ods`.`ods_fichiers_sources_excel_production_declaratives`;

--this table records all of the card production number(in situ)
drop view if exists  dw.`dw_production_declaratives_all_data`;
CREATE
    VIEW dw.`dw_production_declaratives_all_data`  AS
select
    region,
    UPPER(coordination) as coordination,
    site,
    closing_date,
    total,
    period,
    'in suite' as production_type,
    period_type,
    value,
    etl_time
from
    `ods`.`ods_fichiers_sources_excel_production_declaratives`;

--DM LAYER
--this table union the card production(in situ)&card production(prod masse)&total number(tous)of each site in each date
drop view if exists dm.dm_production_declaratives_in_situ_and_prodmass;
create view dm.dm_production_declaratives_in_situ_and_prodmass as
select
    nvl(b.geo_name,info.region) as region,
    coordination,
    site,
    closing_date,
    period,
    DATE_FORMAT(period,'%d-%b-%Y') as eperiod,
    production_type,
    value
from
(select
    region,
    coordination,
    site,
    closing_date,
    period,
    production_type,
    value
from dw.dw_production_declaratives_in_situ_and_prodmass
union all
select
    region,
    coordination,
    site,
    closing_date,
    period,
    'Tous' as production_type,
    sum(value)
from dw.dw_production_declaratives_in_situ_and_prodmass a
group by region,coordination,site,closing_date,period) info
left join dim.dim_country_district b on info.region=b.name
order by site,period;


-- This table records the in-situ&prodmass card production and the stock
create view dm.dm_production_declaratives_in_situ_and_prodmass_stock COMMENT 'VIEW' AS(
select
    a.*,b.stock
from dm.dm_production_declaratives_in_situ_and_prodmass a
left join
    dm.dm_available_inventory_cards_siege_and_region b
on a.site =b.site_name);


----this table records the card production number of site(in situ&prod masse)
drop view if exists dm.dm_production_declaratives_in_situ_and_prodmass_only_site
create view dm.dm_production_declaratives_in_situ_and_prodmass_only_site as
select
    b.geo_name as region,
    coordination,
    site,
    closing_date,
    period,
    DATE_FORMAT(period,'%d-%b-%Y') as eperiod,
    production_type,
    value
from
    (select
         region,
         coordination,
         site,
         closing_date,
         period,
         production_type,
         value
     from dw.dw_production_declaratives_in_situ_and_prodmass_all_data
     where region!='ITINERANCE' and region!=''
     union all
     select
         region,
         coordination,
         site,
         closing_date,
         period,
         'tous' as production_type,
         sum(value)
     from dw.dw_production_declaratives_in_situ_and_prodmass_all_data a
     where region!='ITINERANCE' and region!=''
     group by region,coordination,site,closing_date,period) info
        left join dim.dim_country_district b on info.region=b.name
order by site,period;

----this table records the card production number of camion(in situ&prod masse)
drop view if exists dm.dm_production_declaratives_in_situ_and_prodmass_only_camion;
create view dm.dm_production_declaratives_in_situ_and_prodmass_only_camion as
select
    region,
    coordination,
    site,
    closing_date,
    period,
    DATE_FORMAT(period,'%d-%b-%Y') as eperiod,
    production_type,
    value
from
    (select
         region,
         coordination,
         site,
         closing_date,
         period,
         production_type,
         value
     from dw.dw_production_declaratives_in_situ_and_prodmass_all_data
     where region='ITINERANCE'
     union all
     select
         region,
         coordination,
         site,
         closing_date,
         period,
         'tous' as production_type,
         sum(value)
     from dw.dw_production_declaratives_in_situ_and_prodmass_all_data a
     where region='ITINERANCE'
     group by region,coordination,site,closing_date,period) info
order by site,period;


-- This tables records the number of card production per day
create VIEW dm.`dm_average_card_production_per_day`  AS(
WITH t1 AS (
    SELECT SUM(value) as total_sum
    FROM dm.dm_production_declaratives_in_situ_and_prodmass_stock
    WHERE production_type = 'Tous'
),
t2 AS (
    SELECT COUNT(DISTINCT period) as period_count
    FROM dm.dm_production_declaratives_in_situ_and_prodmass_stock
)
SELECT
    ROUND(t1.total_sum / t2.period_count, 0) as average_value
FROM t1
CROSS JOIN t2);

-- this table records the count of site,active site,camion and active camion
create view dm.dm_site_camion_count as(
WITH
total_site AS (
    SELECT COUNT(DISTINCT site) AS total_site_count
    FROM dm.dm_production_declaratives_in_situ_and_prodmass_only_site
),
active_site AS (
    SELECT COUNT(DISTINCT site) AS active_site_count
    FROM dm.dm_production_declaratives_in_situ_and_prodmass_only_site
    WHERE closing_date IS NULL
),
total_camion AS (
    SELECT COUNT(DISTINCT site) AS total_camion_count
    FROM dm.dm_production_declaratives_in_situ_and_prodmass_only_camion
),
active_camion AS (
    SELECT COUNT(DISTINCT site) AS active_camion_count
    FROM dm.dm_production_declaratives_in_situ_and_prodmass_only_camion
    WHERE closing_date IS NULL
)
SELECT
    total_site_count,
    active_site_count,
    total_camion_count,
    active_camion_count
FROM total_site, active_site, total_camion, active_camion);


/*Indicator NO.24 Stock de cartes vierge préimprimées disponibles*/

-- ODS LAYER
-- This table stores the available inventory of blank pre-printed cards for each site.
DROP TABLE if exists ods.ods_fichiers_sources_excel_cartes_sites;
CREATE TABLE ods.ods_fichiers_sources_excel_cartes_sites (
                                                             `region` VARCHAR(255) NULL,
                                                             `department` VARCHAR(255) NULL,
                                                             `sub_prefecture_commune` VARCHAR(255) NULL,
                                                             `site_name` VARCHAR(255) NULL,
                                                             `type` VARCHAR(255) NULL,
                                                             `number_of_cards_in_stock` DOUBLE NULL,
                                                             `etl_time` DATETIME NULL DEFAULT CURRENT_TIMESTAMP
) ENGINE=OLAP
    DUPLICATE KEY(`region`)
COMMENT 'OLAP'
DISTRIBUTED BY HASH(`region`) BUCKETS 10
PROPERTIES (
    "replication_num" = "2"
);



-- This table stores records of pre-printed blank cards being issued and returned to inventory.
DROP TABLE if exists ods.ods_fichiers_sources_excel_cartes_siege;
CREATE TABLE ods.ods_fichiers_sources_excel_cartes_siege (
                                                             `status` VARCHAR(255) NULL,
                                                             `delivery_date` DATE NULL,
                                                             `number_of_crates` BIGINT NULL,
                                                             `number_of_lattes_per_crate` BIGINT NULL,
                                                             `total_lattes` BIGINT NULL,
                                                             `number_of_cards_per_latte` BIGINT NULL,
                                                             `total_cards` BIGINT NULL,
                                                             `destination` VARCHAR(255) NULL,
                                                             `etl_time` DATETIME NULL DEFAULT CURRENT_TIMESTAMP
) ENGINE=OLAP
    DUPLICATE KEY(`status`, `delivery_date`)
COMMENT 'OLAP'
DISTRIBUTED BY HASH(`status`, `delivery_date`) BUCKETS 10
PROPERTIES (
    "replication_num" = "2"
);

-- DW LAYER
-- dw.`dw_cartes_sites`
DROP VIEW dw.`dw_cartes_sites`;
CREATE
    VIEW dw.`dw_cartes_sites`  AS
select
    region,
    UPPER(department) AS department,
    UPPER(site_name) as site_name,
    type as site_type,
    number_of_cards_in_stock,
    etl_time
from
    `ods`.`ods_fichiers_sources_excel_cartes_sites`;

-- dw.`dw_cartes_siege`
drop view if exists dw.`dw_cartes_siege`;
CREATE VIEW  dw.`dw_cartes_siege` AS
SELECT
    status,
    delivery_date,
    number_of_crates,
    number_of_lattes_per_crate,
    total_lattes,
    number_of_cards_per_latte,
    total_cards,
    destination,
    etl_time
FROM ods.`ods_fichiers_sources_excel_cartes_siege`;




-- DM LAYER
-- This table records the number of inventory cards at headquarters and the number of blank cards available in each region.
drop view if exists dm.dm_available_inventory_cards_siege_and_region;
create view dm.dm_available_inventory_cards_siege_and_region as
select
    region,
    site_name,  -- upper
    stock
from
    (SELECT 'Abidjan' as region
             ,'Siege' as site_name,
            SUM(
                    CASE
                        WHEN status = 'Entrée' THEN total_cards
                        WHEN status = 'Sortie' THEN -total_cards
                        ELSE 0
                        END
            ) AS stock
     FROM dw.`dw_cartes_siege`
     union
     select
         b.geo_name,
         site_name,
         number_of_cards_in_stock
     from
         `dw`.`dw_cartes_sites` a
             left join dim.dim_country_district b on a.region=b.name) site
order by (case when region='Abidjan' then 1 else 2 end);

-- This table stores the quantity of preprinted blank cards by region.
DROP VIEW IF EXISTS dm.`dm_available_blank_cards_by_region`;
CREATE
    VIEW dm.`dm_available_blank_cards_by_region`  AS
select
    A.region,
    B.geo_name,
    A.number_of_cards_in_stock,
    A.etl_time
from
    (
        select
            region,
            sum(number_of_cards_in_stock) as number_of_cards_in_stock,
            max(etl_time)as etl_time
        from
            `dw`.`dw_cartes_sites`
        group by
            region)A
        left join `dim`.`dim_country_district` B on
        A.region = B.name;

-- This table stores the total quantity of preprinted blank cards.
DROP VIEW IF EXISTS dm.dm_available_inventory_cards_total;
CREATE
    VIEW dm.dm_available_inventory_cards_total  AS
select
    sum(number_of_cards_in_stock) as total_number_of_cards_in_stock,
    max(etl_time)as etl_time
from
    `dw`.`dw_cartes_sites`;



/*Indicator NO.39 Taux de départ des agents d'accueil CMU*/
-- ODS LAYER
-- This table stores detailed enrollment, departure and replacement info of CMU reception agents at health centers.DROP TABLE IF EXISTS ods.ods_fichiers_sources_excel_depart_agent_accueil;
CREATE TABLE ods.ods_fichiers_sources_excel_depart_agent_accueil (
  `observation_number` VARCHAR(255) NULL,
  `first_and_last_name` VARCHAR(255) NULL,
  `employee_id` VARCHAR(255) NULL,
  `function_job_title` VARCHAR(255) NULL,
  `department_division` VARCHAR(255) NULL,
  `region` VARCHAR(255) NULL,
  `department` VARCHAR(255) NULL,
  `location` VARCHAR(255) NULL,
  `service` VARCHAR(255) NULL,
  `assigned_health_center` VARCHAR(255) NULL,
  `start_date_of_employment` VARCHAR(255) NULL,
  `departure_date` VARCHAR(255) NULL,
  `type_of_departure` VARCHAR(255) NULL,
  `reason_for_departure` VARCHAR(255) NULL,
  `notice_respected_yes_no` VARCHAR(255) NULL,
  `replacement_identified_yes_no` VARCHAR(255) NULL,
  `first_and_last_name_of_the_replacement` VARCHAR(255) NULL,
  `handover_transition_date` VARCHAR(255) NULL,
  `comments_observations` VARCHAR(255) NULL,
  `etl_time` DATETIME NULL DEFAULT CURRENT_TIMESTAMP
) ENGINE=OLAP
DUPLICATE KEY(`observation_number`)
COMMENT 'OLAP'
DISTRIBUTED BY HASH(`observation_number`) BUCKETS 10
PROPERTIES (
    "replication_num" = "2"
);


-- DW LAYER
-- This table stores detailed enrollment, departure and replacement info of CMU reception agents at health centers.
DROP VIEW IF EXISTS dw.dw_depart_agent_accueil;
CREATE VIEW dw.dw_depart_agent_accueil COMMENT 'VIEW' AS
select
    observation_number,
    first_and_last_name,
    employee_id,
    function_job_title,
    department_division,
    region,
    department,
    location,
    service,
    assigned_health_center,
    start_date_of_employment,
    departure_date,
    type_of_departure,
    reason_for_departure,
    notice_respected_yes_no,
    replacement_identified_yes_no,
    first_and_last_name_of_the_replacement,
    handover_transition_date,
    comments_observations,
    etl_time
from
    `internal`.`ods`.`ods_fichiers_sources_excel_depart_agent_accueil`;


-- DM LAYER
-- This table calculates the monthly turnover rate of CMU health center reception staff (departures divided by active employees at the beginning of the month).
DROP VIEW IF EXISTS dm.`dm_reception_staff_turnover_rate_monthly`;
CREATE VIEW dm.`dm_reception_staff_turnover_rate_monthly` COMMENT 'VIEW' AS
WITH all_months AS (
    SELECT DISTINCT DATE_FORMAT(month_date, '%Y%m') as month_key
    FROM (
        SELECT
            DATE_ADD(first_day_of_first_month,INTERVAL (t2*10 + t1) MONTH) as month_date
        FROM (
            SELECT
                DATE_FORMAT(MIN(start_date_of_employment), '%Y-%m-01') as first_day_of_first_month
            FROM `internal`.`dw`.`dw_depart_agent_accueil`
            WHERE start_date_of_employment IS NOT NULL
        ) first_month
        CROSS JOIN (SELECT 0 as t1 UNION SELECT 1 UNION SELECT 2 UNION SELECT 3 UNION SELECT 4 UNION SELECT 5 UNION SELECT 6 UNION SELECT 7 UNION SELECT 8 UNION SELECT 9) t1
        CROSS JOIN (SELECT 0 as t2 UNION SELECT 1 UNION SELECT 2 UNION SELECT 3 UNION SELECT 4) t2
        WHERE DATE_ADD(
                first_day_of_first_month,
                INTERVAL (t2*10 + t1) MONTH
            ) <= CURDATE()
    ) month_dates
)
SELECT
    COALESCE(departure.departure_num, 0) as departure_num,
    COALESCE(active.active_num, 0) as active_num,
    CASE
        WHEN COALESCE(active.active_num, 0) = 0 THEN 0
        ELSE ROUND(COALESCE(departure.departure_num, 0) / COALESCE(active.active_num, 0), 2)
    END as departure_rate,
    all_months.month_key as analysis_month,
    DATE_FORMAT(STR_TO_DATE(all_months.month_key,'%Y%m'), '%b-%Y') as month,
    COALESCE(departure.etl_time, CURRENT_TIMESTAMP) as etl_time
FROM all_months
LEFT JOIN (
    -- Monthly number of departing employees
    SELECT
        DATE_FORMAT(departure_date, '%Y%m') as month_key,
        COUNT(1) as departure_num,
        MAX(etl_time) as etl_time
    FROM `internal`.`dw`.`dw_depart_agent_accueil`
    WHERE departure_date IS NOT NULL AND departure_date <> ''
    GROUP BY DATE_FORMAT(departure_date, '%Y%m')
) departure ON all_months.month_key = departure.month_key
LEFT JOIN (
    -- Number of active employees at the beginning of each month
    SELECT
        am.month_key,
        COUNT(DISTINCT emp.employee_id) as active_num
    FROM all_months am
    LEFT JOIN `internal`.`dw`.`dw_depart_agent_accueil` emp
        ON emp.start_date_of_employment IS NOT NULL
        -- Employee was hired before the first day of the month
        AND emp.start_date_of_employment <= STR_TO_DATE(CONCAT(am.month_key, '01'), '%Y%m%d')
        -- Employee left after the first day of the month or has not left yet
        AND (
            emp.departure_date IS NULL
            OR emp.departure_date = ''
            OR emp.departure_date > STR_TO_DATE(CONCAT(am.month_key, '01'), '%Y%m%d')
        )
    GROUP BY am.month_key
) active ON all_months.month_key = active.month_key
WHERE active_num IS NOT NULL
ORDER BY all_months.month_key;


-- This table calculates the annual turnover rate of CMU health center reception staff (annual departures divided by active employees at the beginning of the year).
DROP VIEW IF EXISTS dm.`dm_reception_staff_turnover_rate_yearly`;
CREATE VIEW dm.`dm_reception_staff_turnover_rate_yearly` COMMENT 'VIEW' AS
WITH all_years AS (
    SELECT DISTINCT year_key
    FROM (
        SELECT
            DATE_FORMAT(DATE_ADD(first_year_start, INTERVAL t1 YEAR), '%Y') as year_key
        FROM (
            SELECT
                COALESCE(DATE_FORMAT(MIN(start_date_of_employment), '%Y-01-01'), CURDATE()) as first_year_start
            FROM `internal`.`dw`.`dw_depart_agent_accueil`
            WHERE start_date_of_employment IS NOT NULL
        ) first_year
        CROSS JOIN (
            SELECT 0 as t1 UNION SELECT 1 UNION SELECT 2 UNION SELECT 3 UNION SELECT 4
            UNION SELECT 5 UNION SELECT 6 UNION SELECT 7 UNION SELECT 8 UNION SELECT 9
            UNION SELECT 10 UNION SELECT 11 UNION SELECT 12 UNION SELECT 13 UNION SELECT 14
            UNION SELECT 15 UNION SELECT 16 UNION SELECT 17 UNION SELECT 18 UNION SELECT 19
            UNION SELECT 20 UNION SELECT 21 UNION SELECT 22 UNION SELECT 23 UNION SELECT 24
            UNION SELECT 25 UNION SELECT 26 UNION SELECT 27 UNION SELECT 28 UNION SELECT 29
            UNION SELECT 30
        ) t1
        WHERE DATE_ADD(first_year_start, INTERVAL t1 YEAR) <= CURDATE()
    ) year_dates
)
SELECT
    y.year_key as analysis_year,
    COALESCE(departure.departure_num, 0) as departure_num,
    COALESCE(active.active_num, 0) as active_num,
    CASE
        WHEN COALESCE(active.active_num, 0) = 0 THEN 0.00
        ELSE ROUND(COALESCE(departure.departure_num, 0) / active.active_num, 2)
    END as departure_rate,
    COALESCE(departure.etl_time, active.etl_time, CURRENT_TIMESTAMP()) as etl_time
FROM all_years y
LEFT JOIN (
    -- Annual number of departing employees
    SELECT
        YEAR(departure_date) as year_key,
        COUNT(DISTINCT employee_id) as departure_num,
        MAX(etl_time) as etl_time
    FROM `internal`.`dw`.`dw_depart_agent_accueil`
    WHERE departure_date IS NOT NULL
      AND departure_date <> ''
      AND departure_date >= STR_TO_DATE(CONCAT(YEAR(departure_date), '-01-01'), '%Y-%m-%d')
      AND departure_date <= STR_TO_DATE(CONCAT(YEAR(departure_date), '-12-31'), '%Y-%m-%d')
      AND start_date_of_employment IS NOT NULL
    GROUP BY YEAR(departure_date)
) departure ON y.year_key = departure.year_key
LEFT JOIN (
    -- Number of active employees at the beginning of each year (January 1st)
    SELECT
        y_inner.year_key,
        COUNT(DISTINCT emp.employee_id) as active_num,
        MAX(emp.etl_time) as etl_time
    FROM all_years y_inner
    CROSS JOIN `internal`.`dw`.`dw_depart_agent_accueil` emp
    WHERE emp.start_date_of_employment IS NOT NULL
      -- Employee was hired before January 1st of the year
      AND emp.start_date_of_employment <= STR_TO_DATE(CONCAT(y_inner.year_key, '-01-01'), '%Y-%m-%d')
      -- Employee left after January 1st of the year or has not left yet
      AND (
          emp.departure_date IS NULL
          OR emp.departure_date = ''
          OR emp.departure_date > STR_TO_DATE(CONCAT(y_inner.year_key, '-01-01'), '%Y-%m-%d')
      )
    GROUP BY y_inner.year_key
) active ON y.year_key = active.year_key
ORDER BY y.year_key ASC;


-- This table calculates the monthly turnover rate of CMU reception staff by each health center (departures divided by active employees at the beginning of the month per center).
DROP VIEW IF EXISTS dm.`dm_reception_staff_turnover_rate_monthly_by_health_center`;
CREATE VIEW dm.`dm_reception_staff_turnover_rate_monthly_by_health_center` COMMENT 'VIEW' AS
WITH all_months AS (
    SELECT DISTINCT DATE_FORMAT(month_date, '%Y%m') as month_key,
           DATE_FORMAT(month_date, '%Y-%m-01') as month_first_day
    FROM (
        SELECT
            DATE_ADD(first_day_of_first_month, INTERVAL (t2*10 + t1) MONTH) as month_date
        FROM (
            SELECT
                DATE_FORMAT(MIN(start_date_of_employment), '%Y-%m-01') as first_day_of_first_month
            FROM `internal`.`dw`.`dw_depart_agent_accueil`
            WHERE start_date_of_employment IS NOT NULL
        ) first_month
        CROSS JOIN (SELECT 0 as t1 UNION SELECT 1 UNION SELECT 2 UNION SELECT 3 UNION SELECT 4 UNION SELECT 5 UNION SELECT 6 UNION SELECT 7 UNION SELECT 8 UNION SELECT 9) t1
        CROSS JOIN (SELECT 0 as t2 UNION SELECT 1 UNION SELECT 2 UNION SELECT 3 UNION SELECT 4) t2
        WHERE DATE_ADD(first_day_of_first_month, INTERVAL (t2*10 + t1) MONTH) <= CURDATE()
    ) month_dates
),
all_health_centers AS (
    SELECT DISTINCT assigned_health_center
    FROM `internal`.`dw`.`dw_depart_agent_accueil`
    WHERE assigned_health_center IS NOT NULL
      AND TRIM(assigned_health_center) <> ''
),
month_center_combinations AS (
    SELECT
        am.month_key,
        am.month_first_day,
        hc.assigned_health_center
    FROM all_months am
    CROSS JOIN all_health_centers hc
)
SELECT
    mcc.assigned_health_center as health_center_name,
    COALESCE(departure.departure_num, 0) as departure_num,
    COALESCE(active.active_num, 0) as active_num,
    CASE
        WHEN COALESCE(active.active_num, 0) = 0 THEN 0
        ELSE ROUND(COALESCE(departure.departure_num, 0) / active.active_num, 2)
    END as departure_rate,
    mcc.month_key as analysis_month,
	year(STR_TO_DATE(mcc.month_key,'%Y%m')) as year,
    DATE_FORMAT(STR_TO_DATE(mcc.month_key,'%Y%m'), '%b-%Y') as month,
    COALESCE(departure.etl_time, active.etl_time, CURRENT_TIMESTAMP) as etl_time
FROM month_center_combinations mcc
LEFT JOIN (
    -- Monthly number of departing employees per assigned health center
    SELECT
        DATE_FORMAT(departure_date, '%Y%m') as month_key,
        assigned_health_center,
        COUNT(1) as departure_num,
        MAX(etl_time) as etl_time
    FROM `internal`.`dw`.`dw_depart_agent_accueil`
    WHERE departure_date IS NOT NULL
      AND departure_date <> ''
      AND assigned_health_center IS NOT NULL
      AND TRIM(assigned_health_center) <> ''
    GROUP BY DATE_FORMAT(departure_date, '%Y%m'), assigned_health_center
) departure ON mcc.month_key = departure.month_key
            AND mcc.assigned_health_center = departure.assigned_health_center
LEFT JOIN (
    -- Number of active employees at the beginning of each month per assigned health center
    SELECT
        mcc.month_key,
        mcc.assigned_health_center,
        COUNT(DISTINCT emp.employee_id) as active_num,
        MAX(emp.etl_time) as etl_time
    FROM month_center_combinations mcc
    LEFT JOIN `internal`.`dw`.`dw_depart_agent_accueil` emp
        ON mcc.assigned_health_center = emp.assigned_health_center
        AND emp.start_date_of_employment IS NOT NULL
        -- Employee was hired before the first day of the month
        AND emp.start_date_of_employment <= mcc.month_first_day
        -- Employee left after the first day of the month or has not left yet
        AND (
            emp.departure_date IS NULL
            OR emp.departure_date = ''
            OR emp.departure_date >= mcc.month_first_day
        )
    GROUP BY mcc.month_key, mcc.assigned_health_center
) active ON mcc.month_key = active.month_key
         AND mcc.assigned_health_center = active.assigned_health_center
WHERE COALESCE(active.active_num, departure.departure_num, 0) > 0
ORDER BY mcc.month_key, mcc.assigned_health_center;


-- This table calculates the annual turnover rate of CMU reception staff by each health center (annual departures divided by active employees at the beginning of the year per center).
DROP VIEW IF EXISTS dm.`dm_reception_staff_turnover_rate_yearly_by_health_center`;
CREATE VIEW dm.`dm_reception_staff_turnover_rate_yearly_by_health_center`
COMMENT 'VIEW' AS
WITH all_years AS (
    SELECT DISTINCT year_key
    FROM (
        SELECT
            DATE_FORMAT(DATE_ADD(first_year_start, INTERVAL t1 YEAR), '%Y') as year_key
        FROM (
            SELECT
                COALESCE(DATE_FORMAT(MIN(start_date_of_employment), '%Y-01-01'), CURDATE()) as first_year_start
            FROM `internal`.`dw`.`dw_depart_agent_accueil`
            WHERE start_date_of_employment IS NOT NULL
        ) first_year
        CROSS JOIN (
            SELECT 0 as t1 UNION SELECT 1 UNION SELECT 2 UNION SELECT 3 UNION SELECT 4
            UNION SELECT 5 UNION SELECT 6 UNION SELECT 7 UNION SELECT 8 UNION SELECT 9
            UNION SELECT 10 UNION SELECT 11 UNION SELECT 12 UNION SELECT 13 UNION SELECT 14
            UNION SELECT 15 UNION SELECT 16 UNION SELECT 17 UNION SELECT 18 UNION SELECT 19
            UNION SELECT 20 UNION SELECT 21 UNION SELECT 22 UNION SELECT 23 UNION SELECT 24
            UNION SELECT 25 UNION SELECT 26 UNION SELECT 27 UNION SELECT 28 UNION SELECT 29
            UNION SELECT 30
        ) t1
        WHERE DATE_ADD(first_year_start, INTERVAL t1 YEAR) <= CURDATE()
    ) year_dates
),
all_health_centers AS (
    SELECT DISTINCT TRIM(assigned_health_center) as assigned_health_center
    FROM `internal`.`dw`.`dw_depart_agent_accueil`
    WHERE assigned_health_center IS NOT NULL
      AND TRIM(assigned_health_center) <> ''
),
year_hc_combinations AS (
    SELECT
        ay.year_key,
        ahc.assigned_health_center
    FROM all_years ay
    CROSS JOIN all_health_centers ahc
)
SELECT
    yhc.assigned_health_center as health_center_name,
    COALESCE(departure.departure_num, 0) as departure_num,
    COALESCE(active.active_num, 0) as active_num,
    CASE
        WHEN COALESCE(active.active_num, 0) = 0 THEN 0.00
        ELSE ROUND(COALESCE(departure.departure_num, 0) / active.active_num, 2)
    END as departure_rate,
    yhc.year_key as analysis_year,
    COALESCE(departure.etl_time, active.etl_time, CURRENT_TIMESTAMP()) as etl_time
FROM year_hc_combinations yhc
LEFT JOIN (
    -- Annual number of departing employees per assigned health center
    SELECT
        YEAR(departure_date) as year_key,
        TRIM(assigned_health_center) as assigned_health_center,
        COUNT(DISTINCT employee_id) as departure_num,
        MAX(etl_time) as etl_time
    FROM `internal`.`dw`.`dw_depart_agent_accueil`
    WHERE departure_date IS NOT NULL
      AND departure_date <> ''
      AND assigned_health_center IS NOT NULL
      AND TRIM(assigned_health_center) <> ''
      AND start_date_of_employment IS NOT NULL
      AND departure_date >= STR_TO_DATE(CONCAT(YEAR(departure_date), '-01-01'), '%Y-%m-%d')
      AND departure_date <= STR_TO_DATE(CONCAT(YEAR(departure_date), '-12-31'), '%Y-%m-%d')
    GROUP BY YEAR(departure_date), TRIM(assigned_health_center)
) departure ON yhc.year_key = departure.year_key
            AND yhc.assigned_health_center = departure.assigned_health_center
LEFT JOIN (
    -- Number of active employees at the beginning of each year (January 1st) per assigned health center
    SELECT
        y_inner.year_key,
        TRIM(emp.assigned_health_center) as assigned_health_center,
        COUNT(DISTINCT emp.employee_id) as active_num,         MAX(emp.etl_time) as etl_time
    FROM all_years y_inner
    CROSS JOIN `internal`.`dw`.`dw_depart_agent_accueil` emp
    WHERE emp.assigned_health_center IS NOT NULL
      AND TRIM(emp.assigned_health_center) <> ''
      AND emp.start_date_of_employment IS NOT NULL
      -- Employee was hired before January 1st of the year
      AND emp.start_date_of_employment <= STR_TO_DATE(CONCAT(y_inner.year_key, '-01-01'), '%Y-%m-%d')
      -- Employee left after January 1st of the year or has not left yet
      AND (
          emp.departure_date IS NULL
          OR emp.departure_date = ''
          OR emp.departure_date > STR_TO_DATE(CONCAT(y_inner.year_key, '-01-01'), '%Y-%m-%d')
      )
    GROUP BY y_inner.year_key, TRIM(emp.assigned_health_center)
) active ON yhc.year_key = active.year_key
         AND yhc.assigned_health_center = active.assigned_health_center
WHERE COALESCE(active.active_num, departure.departure_num, 0) > 0
ORDER BY yhc.year_key ASC, yhc.assigned_health_center ASC;


/*Indicator NO.45 Nombre de centres de santé conventionnées&*Indicator NO.46 Taux de couverture du réseau de soins CMU (centre de santé)*/
---ODS LAYER
CREATE TABLE `ods_fichiers_sources_excel_liste_centres_sante_conventionnes` (
  `health_region` VARCHAR(255) NULL,
  `health_district` VARCHAR(255) NULL,
  `departmental_direction` VARCHAR(255) NULL,
  `sub_prefecture` VARCHAR(255) NULL,
  `location` VARCHAR(255) NULL,
  `cnam_establishment_code` VARCHAR(255) NULL,
  `business_name` VARCHAR(255) NULL,
  `center_type` VARCHAR(255) NULL,
  `pyramid_level` INT NULL,
  `contract_date` DATE NULL,
  `etl_time` DATETIME NULL DEFAULT CURRENT_TIMESTAMP
) ENGINE=OLAP
DUPLICATE KEY(`health_region`, `health_district`)
COMMENT 'OLAP'
DISTRIBUTED BY HASH(`health_region`, `health_district`) BUCKETS 10
PROPERTIES (
    "replication_num" = "2"
);

CREATE TABLE `ods_fichiers_sources_excel_liste_centres_sante` (
  `sanitary_region` VARCHAR(255) NULL,
  `sanitary_district` VARCHAR(255) NULL,
  `locality` VARCHAR(255) NULL,
  `business_name` VARCHAR(255) NULL,
  `center_type` VARCHAR(255) NULL,
  `category` VARCHAR(255) NULL,
  `pyramid_level` BIGINT NULL,
  `etl_time` DATETIME NULL DEFAULT CURRENT_TIMESTAMP
) ENGINE=OLAP
DUPLICATE KEY(`sanitary_region`, `sanitary_district`)
COMMENT 'OLAP'
DISTRIBUTED BY HASH(`sanitary_region`, `sanitary_district`) BUCKETS 10
PROPERTIES (
    "replication_num" = "2"
);

-- DW LAYER
CREATE OR REPLACE
VIEW `dw_liste_centres_sante_conventionnes` COMMENT 'VIEW' AS
select
    health_region,
    health_district,
    departmental_direction,
    sub_prefecture,
    location,
    cnam_establishment_code,
    business_name,
    center_type,
    pyramid_level,
    contract_date,
    etl_time
from
    `internal`.`ods`.`ods_fichiers_sources_excel_liste_centres_sante_conventionnes`;

CREATE OR REPLACE
VIEW `dw_liste_centres_sante` COMMENT 'VIEW' AS
select
    sanitary_region,
    sanitary_district,
    locality,
    business_name,
    center_type,
    category,
    pyramid_level,
    etl_time
from
    `internal`.`ods`.`ods_fichiers_sources_excel_liste_centres_sante`;

-- DM LAYER
-- this table defines the coverage rate of the contracted health center
CREATE VIEW `dm`.`dm_contracted_health_center_coverage_rate_by_region` COMMENT 'VIEW' AS
select
	AA.geo_name,
	AA.center_type,
	AA.pyramid_level,
	AA.health_centers_number,
	BB.sanitary_number,
	BB.sanitary_number / AA.health_centers_number as coverage_rate
from
(select
	B.geo_name,
	A.center_type,
	A.pyramid_level,
	count(1) as health_centers_number
from `dw`.`dw_liste_centres_sante_conventionnes` A
left join `dim`.`dim_country_district` B
on A.health_region = B.name
group by
	B.geo_name,
	A.center_type,
	A.pyramid_level)AA
left join
(select
	B.geo_name,
	A.center_type,
	A.pyramid_level,
	count(1) as sanitary_number
from `dw`.`dw_liste_centres_sante` A
left join `dim`.`dim_country_district` B
on A.sanitary_region = B.name
group by
	B.geo_name,
	A.center_type,
	A.pyramid_level)BB
on AA.geo_name = BB.geo_name
and AA.center_type = BB.center_type
and AA.pyramid_level = BB.pyramid_level;

/*Indicater 47 Nombre de pharmacies conventionnées&Indicater 48 Taux de couverture du réseau des pharmacies*/
-- ODS LAYER
CREATE TABLE `ods_fichiers_sources_excel_liste_pharmacie_conventionnes` (
  `sanitary_region` VARCHAR(255) NULL,
  `sanitary_district` VARCHAR(255) NULL,
  `departmental_direction` VARCHAR(255) NULL,
  `sub_prefecture` VARCHAR(255) NULL,
  `city` VARCHAR(255) NULL,
  `office_code` VARCHAR(255) NULL,
  `business_name` VARCHAR(255) NULL,
  `etl_time` DATETIME NULL DEFAULT CURRENT_TIMESTAMP
) ENGINE=OLAP
DUPLICATE KEY(`sanitary_region`, `sanitary_district`)
COMMENT 'OLAP'
DISTRIBUTED BY HASH(`sanitary_region`, `sanitary_district`) BUCKETS 10
PROPERTIES (
    "replication_num" = "2"
);

CREATE TABLE `ods_fichiers_sources_excel_liste_pharmacie` (
  `regions` VARCHAR(255) NULL,
  `department` VARCHAR(255) NULL,
  `locality` DOUBLE NULL,
  `establishment_name` VARCHAR(255) NULL,
  `etl_time` DATETIME NULL DEFAULT CURRENT_TIMESTAMP
) ENGINE=OLAP
DUPLICATE KEY(`regions`)
COMMENT 'OLAP'
DISTRIBUTED BY HASH(`regions`) BUCKETS 10
PROPERTIES (
    "replication_num" = "2"
);

--DW LAYER
CREATE OR REPLACE
VIEW `dw_liste_pharmacie_conventionnes` COMMENT 'VIEW' AS
select
    sanitary_region,
    sanitary_district,
    departmental_direction,
    sub_prefecture,
    city,
    office_code,
    business_name,
    etl_time
from
    `internal`.`ods`.`ods_fichiers_sources_excel_liste_pharmacie_conventionnes`;

CREATE OR REPLACE
VIEW `dw_liste_pharmacie` COMMENT 'VIEW' AS
select
    regions,
    department,
    locality,
    establishment_name,
    etl_time
from
    `internal`.`ods`.`ods_fichiers_sources_excel_liste_pharmacie`;

-- DM LAYER
-- this table defines the coverage rate of the contracted pharmacies
drop view `dm`.`dm_bm_pharmacy_network_coverage_rate_region`;
CREATE VIEW `dm`.`dm_contracted_pharmacy_coverage_rate_by_region` COMMENT 'VIEW' AS
select
    A.geo_name,
    B.sanitary_number,
    A.pharmacie_number,
    B.sanitary_number / A.pharmacie_number as coverage_rate
from
    (select geo_name, sum(pharmacie_number) as pharmacie_number from `internal`.`dm`.`dm_bm_number_pharmacie_region` group by geo_name) A
left join (
    select
        geo_name,
        sum(sanitary_number) as sanitary_number
    from
        `internal`.`dm`.`dm_bm_number_contracted_pharmacies_region`
    group by
        geo_name) B
on
    A.geo_name = B.geo_name;

-- this table defines the contracted and total count of pharmacy and health center and their coverage rate
CREATE VIEW `dm`.`dm_health_center_and_pharmacy_coverage_rate` COMMENT 'VIEW' AS
SELECT
    health_centers.contracted_health_center_cnt,
    health_centers.total_health_center_cnt,
    health_centers.contracted_health_center_coverage_rate,
    pharmacies.contracted_pharmacy_cnt,
    pharmacies.total_pharmacy_cnt,
    pharmacies.contracted_pharmacy_coverage_rate
FROM
    (SELECT
        SUM(health_centers_number) AS contracted_health_center_cnt,
        SUM(sanitary_number) AS total_health_center_cnt,
        SUM(health_centers_number) / SUM(sanitary_number) AS contracted_health_center_coverage_rate
     FROM dm.dm_contracted_health_center_coverage_rate_by_region
    ) AS health_centers
CROSS JOIN
    (SELECT
        SUM(sanitary_number) AS contracted_pharmacy_cnt,
        SUM(pharmacie_number) AS total_pharmacy_cnt,
        SUM(sanitary_number) / SUM(pharmacie_number) AS contracted_pharmacy_coverage_rate
     FROM dm.dm_contracted_pharmacy_coverage_rate_by_region
    ) AS pharmacies;


/*Indicator NO.47 Nombre de pharmacies conventionnées&Indicator NO.48 Taux de couverture du réseau des pharmacies*/
---ODS LAYER
CREATE TABLE `ods_fichiers_sources_excel_liste_pharmacie` (
  `regions` VARCHAR(255) NULL,
  `department` VARCHAR(255) NULL,
  `locality` DOUBLE NULL,
  `establishment_name` VARCHAR(255) NULL,
  `etl_time` DATETIME NULL DEFAULT CURRENT_TIMESTAMP
) ENGINE=OLAP
DUPLICATE KEY(`regions`)
COMMENT 'OLAP'
DISTRIBUTED BY HASH(`regions`) BUCKETS 10
PROPERTIES (
    "replication_num" = "2"
);

CREATE TABLE `ods_fichiers_sources_excel_liste_pharmacie_conventionnes` (
  `sanitary_region` VARCHAR(255) NULL,
  `sanitary_district` VARCHAR(255) NULL,
  `departmental_direction` VARCHAR(255) NULL,
  `sub_prefecture` VARCHAR(255) NULL,
  `city` VARCHAR(255) NULL,
  `office_code` VARCHAR(255) NULL,
  `business_name` VARCHAR(255) NULL,
  `etl_time` DATETIME NULL DEFAULT CURRENT_TIMESTAMP
) ENGINE=OLAP
DUPLICATE KEY(`sanitary_region`, `sanitary_district`)
COMMENT 'OLAP'
DISTRIBUTED BY HASH(`sanitary_region`, `sanitary_district`) BUCKETS 10
PROPERTIES (
    "replication_num" = "2"
);

--DW LAYER
CREATE OR REPLACE
VIEW `dw_liste_pharmacie_conventionnes` COMMENT 'VIEW' AS
select
    sanitary_region,
    sanitary_district,
    departmental_direction,
    sub_prefecture,
    city,
    office_code,
    business_name,
    etl_time
from
    `internal`.`ods`.`ods_fichiers_sources_excel_liste_pharmacie_conventionnes`;

CREATE OR REPLACE
VIEW `dw_liste_pharmacie` COMMENT 'VIEW' AS
select
    regions,
    department,
    locality,
    establishment_name,
    etl_time
from
    `internal`.`ods`.`ods_fichiers_sources_excel_liste_pharmacie`;

--DM LAYER
CREATE VIEW `dm`.`dm_contracted_pharmacy_coverage_rate_by_region` COMMENT 'VIEW' AS
select
    A.geo_name,
    B.sanitary_number,
    A.pharmacie_number,
    B.sanitary_number / A.pharmacie_number as coverage_rate
from
    (select geo_name, sum(pharmacie_number) as pharmacie_number from `internal`.`dm`.`dm_bm_number_pharmacie_region` group by geo_name) A
left join (
    select
        geo_name,
        sum(sanitary_number) as sanitary_number
    from
        `internal`.`dm`.`dm_bm_number_contracted_pharmacies_region`
    group by
        geo_name) B
on
    A.geo_name = B.geo_name;

CREATE VIEW `dm`.`dm_health_center_and_pharmacy_coverage_rate` COMMENT 'VIEW' AS
SELECT
    health_centers.contracted_health_center_cnt,
    health_centers.total_health_center_cnt,
    health_centers.contracted_health_center_coverage_rate,
    pharmacies.contracted_pharmacy_cnt,
    pharmacies.total_pharmacy_cnt,
    pharmacies.contracted_pharmacy_coverage_rate
FROM
    (SELECT
        SUM(health_centers_number) AS contracted_health_center_cnt,
        SUM(sanitary_number) AS total_health_center_cnt,
        SUM(health_centers_number) / SUM(sanitary_number) AS contracted_health_center_coverage_rate
     FROM dm.dm_contracted_health_center_coverage_rate_by_region
    ) AS health_centers
CROSS JOIN
    (SELECT
        SUM(sanitary_number) AS contracted_pharmacy_cnt,
        SUM(pharmacie_number) AS total_pharmacy_cnt,
        SUM(sanitary_number) / SUM(pharmacie_number) AS contracted_pharmacy_coverage_rate
     FROM dm.dm_contracted_pharmacy_coverage_rate_by_region
    ) AS pharmacies;

/*Indicator NO.75 Nombre de campagnes de communication réalisées*/
---ODS LAYER
CREATE TABLE `ods_fichiers_sources_excel_campagne_communication` (
  `year` BIGINT NULL,
  `month` BIGINT NULL,
  `campaign_name` VARCHAR(255) NULL,
  `status` VARCHAR(255) NULL,
  `etl_time` DATETIME NULL DEFAULT CURRENT_TIMESTAMP
) ENGINE=OLAP
DUPLICATE KEY(`year`, `month`)
COMMENT 'OLAP'
DISTRIBUTED BY HASH(`year`, `month`) BUCKETS 10
PROPERTIES (
    "replication_num" = "2"
);
---DW LAYER
CREATE OR REPLACE
VIEW `dw_campagne_communication` COMMENT 'VIEW' AS
select
    year as campagne_year,
    case
        when month < 10 then concat('0', month)
        else month
    end as campagne_month,
    campaign_name,
    status,
    etl_time
from
    `internal`.`ods`.`ods_fichiers_sources_excel_campagne_communication`;
---DM LAYER
??????

/*Indicator NO.76 Taux de notoriété de la CNAM*/
---ODS LAYER
CREATE TABLE `ods_fichiers_sources_excel_notoriete_cnam` (
  `year` BIGINT NULL,
  `rate` VARCHAR(255) NULL,
  `etl_time` DATETIME NULL DEFAULT CURRENT_TIMESTAMP
) ENGINE=OLAP
DUPLICATE KEY(`year`)
COMMENT 'OLAP'
DISTRIBUTED BY HASH(`year`) BUCKETS 10
PROPERTIES (
    "replication_num" = "2"
);

-- DW LAYER
CREATE OR REPLACE
VIEW `dw_notoriete_cnam` COMMENT 'VIEW' AS
select
    year as notoriete_year,
    case
         when right(rate,1) = '%' then SUBSTRING_INDEX('93.7%', '%', 1)/100
    else rate end as rate,
    etl_time
from
    `internal`.`ods`.`ods_fichiers_sources_excel_notoriete_cnam`;

-- DM LAYER
CREATE OR REPLACE
VIEW `dm_ccm_cnam_awareness_rate_yearly` COMMENT 'VIEW' AS
select
    notoriete_year,
    cast(rate as double) as rate,
    etl_time
from
    `internal`.`dw`.`dw_notoriete_cnam`;

/*Indicator NO.77 Nombre de visteurs sur le site web*/
---ODS LAYER
CREATE TABLE `ods_fichiers_sources_excel_visite_site_web` (
  `date` DATE NULL,
  `number_of_visitors` BIGINT NULL,
  `etl_time` DATETIME NULL DEFAULT CURRENT_TIMESTAMP
) ENGINE=OLAP
DUPLICATE KEY(`date`)
COMMENT 'OLAP'
DISTRIBUTED BY HASH(`date`) BUCKETS 10
PROPERTIES (
    "replication_num" = "2"
);

-- DW LAYER
CREATE OR REPLACE
VIEW `dw_visite_site_web` COMMENT 'VIEW' AS
select
    date as visite_date,
    number_of_visitors,
    etl_time
from
    `internal`.`ods`.`ods_fichiers_sources_excel_visite_site_web`;

-- DM LAYER
????
